{% extends '00_base.html' %}
{% block title %}AUTO UPBIT 실전 대시보드{% endblock %}
{% block content %}
  <!-- 4분할 상단 Row -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-10">
    <div class="bg-gray-800 rounded-2xl shadow p-6 flex flex-col justify-center items-start h-36 min-w-[180px]">
      <div class="text-xs text-gray-400 mb-1">KRW 잔고</div>
      <div class="text-xs text-gray-500 mb-1">계좌 보유 현금</div>
      <div id="krw-balance" class="text-3xl font-extrabold tracking-tight">0</div>
    </div>
    <div class="bg-gray-800 rounded-2xl shadow p-6 flex flex-col justify-center items-start h-36 min-w-[180px]">
      <div class="text-xs text-gray-400 mb-1">오늘 손익(PnL)</div>
      <div class="text-xs text-gray-500 mb-1">금일 실현 손익</div>
      <div class="flex items-baseline">
        <span id="pnl-amount" class="text-3xl font-extrabold tracking-tight mr-2">0</span>
      </div>
    </div>
    <!-- 모니터링 코인 카드 -->
    <div class="bg-gray-800 rounded-2xl shadow p-6 flex flex-col h-36 relative">
      <div class="flex items-center justify-between mb-2">
        <span class="card-title text-white">모니터링 코인</span>
        <button onclick="openMonitorModal()"
                class="text-gray-400 hover:text-green-400 p-1 rounded-full transition absolute right-4 top-4"
                title="조건 설정">
          <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3.5" />
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33
                     1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51
                     1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82
                     1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09c.66 0 1.26-.35 1.51-1a1.65 1.65 0 0 0-.33-1.82l-.06-.06
                     a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 9 3.09V3a2 2 0 0 1 4 0v.09
                     c0 .66.35 1.26 1 1.51a1.65 1.65 0 0 0 1.82-.33l.06-.06
                     a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82
                     v.09c0 .66.35 1.26 1 1.51z"/>
          </svg>
        </button>
      </div>
      <div class="text-xs text-gray-500 mb-1">실시간 감시중인 종목</div>
      <div class="relative mt-1 overflow-x-auto">
        <div class="grid grid-rows-2 grid-flow-col gap-2 pr-4">
          {% for ticker in universe %}
          <span class="inline-flex items-center justify-center px-3 py-1 rounded-lg bg-green-400 text-xs font-bold text-gray-900 min-w-[48px]">
            {{ ticker.replace('KRW-', '') }}
          </span>
          {% endfor %}
        </div>
        {% if universe|length > 8 %}
        <div class="pointer-events-none absolute inset-y-0 right-0 w-5 flex items-center justify-center bg-gradient-to-l from-gray-800">
          <svg class="w-3 h-3 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7 4l5 6-5 6V4z" clip-rule="evenodd" />
          </svg>
        </div>
        {% endif %}
      </div>
    </div>
    <!-- 자동매매 카드 -->
    <div class="bg-gray-800 rounded-2xl shadow p-6 flex flex-col justify-between h-36 min-w-[200px] relative">
      <div class="flex items-center justify-between mb-3">
        <span class="card-title text-white">자동매매</span>
        <label class="toggle-switch ml-2" title="자동매매 실행/중지">
          <input id="autotrade-toggle" type="checkbox" onchange="toggleStatus(this)">
          <span class="toggle-slider">
            <span class="toggle-dot"></span>
          </span>
        </label>
      </div>
        <span id="run-status"
              class="w-full px-3 py-1 rounded-full text-sm font-bold bg-gray-700 text-gray-300 text-center mb-1">
          중단 상태
        </span>
      <div class="text-xs text-gray-500 mb-1">자동매매 실행 상태</div>
      <div id="autotrade-updated" class="text-xs text-gray-400 text-right w-full mt-1">업데이트: -</div>
    </div>
  </div>

  <!-- 매도 모니터링 -->
  <div class="bg-gray-800 rounded-2xl shadow p-7 mb-8">
    <h2 class="text-xl font-bold mb-4">매도 모니터링</h2>
    <div class="overflow-x-auto">
      <table class="w-full text-sm align-middle">
        <thead>
          <tr class="text-gray-400 border-b border-gray-700 text-center">
            <th class="py-2 font-semibold">코인</th>
            <th class="py-2 font-semibold td-strategy">전략</th>
            <th class="py-2 font-semibold">진입가</th>
            <th class="py-2 font-semibold">매수평균가</th>
            <th class="py-2 font-semibold">현재가</th>
            <th class="py-2 font-semibold">평가금액</th>
            <th class="py-2 font-semibold">수익 구간</th>
            <th class="py-2 font-semibold">수익률</th>
            <th class="py-2 font-semibold">불타기</th>
            <th class="py-2 font-semibold">물타기</th>
          </tr>
        </thead>
        <tbody id="positions-body"></tbody>
      </table>
    </div>
  </div>

  <div class="bg-gray-800 rounded-2xl shadow p-7 mb-10">
    <h2 class="text-xl font-bold mb-4">실시간 알림/이벤트</h2>
    <ul id="events-list" class="max-h-48 overflow-y-auto space-y-1"></ul>
  </div>

  <!-- 모니터링 코인 조건 팝업(모달) -->
  <div id="monitorModal"
       class="hidden fixed z-50 inset-0 modal-bg fade-in flex items-center justify-center">
    <div class="bg-gray-800 rounded-2xl shadow-xl p-8 w-full max-w-md border border-green-400/40">
      <div class="flex items-center mb-4 justify-between">
        <span class="card-title text-white">모니터링 코인 조건 설정</span>
        <button onclick="closeMonitorModal()"
                class="text-gray-400 hover:text-green-400 px-2 rounded transition text-xl">&times;</button>
      </div>
      <form onsubmit="event.preventDefault(); saveMonitorCondition();">
        <div class="mb-3">
          <label class="input-label block mb-1">최소 가격(원)</label>
          <input type="number" step="0.1" min="0" id="minPrice"
                 class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700 text-white"
                 class="focus:outline-none focus:border-green-400"
                 value="{{ config.min_price }}">
        </div>
        <div class="mb-3">
          <label class="input-label block mb-1">최대 가격(원)</label>
          <input type="number" step="0.1" min="0" id="maxPrice"
                 class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700 text-white"
                 class="focus:outline-none focus:border-green-400"
                 value="{{ config.max_price }}">
        </div>
        <div class="mb-3">
          <label class="input-label block mb-1">변동성 하한(%)</label>
          <input type="number" step="0.01" min="0" max="100" id="minVolatility"
                 class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700 text-white"
                 class="focus:outline-none focus:border-green-400"
                 value="{{ config.min_volatility }}">
        </div>
        <div class="mb-5">
          <label class="input-label block mb-1">24h 거래대금 순위(Top N)</label>
          <input type="number" min="1" max="50" id="volumeRank"
                 class="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700 text-white"
                 class="focus:outline-none focus:border-green-400"
                 value="{{ config.volume_rank }}">
        </div>
        <div class="flex gap-2">
          <button type="button" onclick="closeMonitorModal()"
                  class="flex-1 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white font-semibold">취소</button>
          <button type="submit"
                  class="flex-1 py-2 bg-green-500 hover:bg-green-400 rounded text-gray-900 font-bold transition">
            저장
          </button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
function updateAccount() {
  fetch('/api/account')
    .then(r => r.json())
    .then(d => {
      const krw = document.getElementById('krw-balance');
      if (krw) krw.textContent = Number(d.krw_balance).toLocaleString();
      const pnl = document.getElementById('pnl-amount');
      if (pnl) pnl.textContent = Number(d.pnl).toLocaleString();
    })
    .catch(console.error);
}
updateAccount();
setInterval(updateAccount, 10000);

function fetchAutoTradeStatus() {
  fetch('/api/auto_trade_status')
    .then(r => r.json())
    .then(d => {
      const checkbox = document.getElementById('autotrade-toggle');
      const status = document.getElementById('run-status');
      const updated = document.getElementById('autotrade-updated');
      if (checkbox) checkbox.checked = d.enabled;
      if (status) {
        if (d.enabled) {
          status.textContent = '실행중';
          status.className =
            'w-full px-3 py-1 rounded-full text-sm font-bold bg-green-700 text-green-200 text-center mb-1';
        } else {
          status.textContent = '중단 상태';
          status.className =
            'w-full px-3 py-1 rounded-full text-sm font-bold bg-gray-700 text-gray-300 text-center mb-1';
        }
      }
      if (updated) updated.textContent = '업데이트: ' + d.updated_at;
    })
    .catch(err => {
      console.error(err);
      const status = document.getElementById('run-status');
      if (status) {
        status.textContent = '연결 오류';
        status.className =
          'w-full px-3 py-1 rounded-full text-sm font-bold bg-red-700 text-red-200 text-center mb-1';
      }
    });
}

function fetchPositions() {
  fetch('/api/open_positions')
    .then(r => r.json())
    .then(data => {
      const body = document.getElementById('positions-body');
      if (!body) return;
      body.innerHTML = '';
      if (data.length === 0) {
        // Display a single row when there are no open positions
        const row = document.createElement('tr');
        row.className = 'text-center';
        const cell = document.createElement('td');
        cell.colSpan = 10;
        cell.textContent = '포지션 없음';
        row.appendChild(cell);
        body.appendChild(row);
        return;
      }
      data.forEach(pos => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-700 text-center';
        row.innerHTML = `
          <td class="td-coin">${pos.symbol.replace('KRW-', '')}</td>
          <td class="td-strategy">${pos.strategy ?? '-'}</td>
          <td class="td-price">${Number(pos.entry_price ?? 0).toLocaleString()}</td>
          <td class="td-price">${Number(pos.avg_price ?? 0).toLocaleString()}</td>
          <td class="td-price">${Number(pos.current_price ?? 0).toLocaleString()}</td>
          <td class="td-price">${Number(pos.eval_amount ?? 0).toLocaleString()}</td>
          <td class="td-graph"></td>
          <td class="td-pnl">${Number(pos.pnl_percent ?? 0).toFixed(2)}%</td>
          <td class="td-burn">${pos.pyramid_count ?? 0}</td>
          <td class="td-add">${pos.avgdown_count ?? 0}</td>`;
        body.appendChild(row);
      });
    })
    .catch(console.error);
}

function fetchEvents() {
  fetch('/api/events?limit=20')
    .then(r => r.json())
    .then(data => {
      const list = document.getElementById('events-list');
      if (!list) return;
      list.innerHTML = '';
      if (data.length === 0) {
        const li = document.createElement('li');
        li.textContent = '최근 이벤트 없음';
        list.appendChild(li);
        return;
      }
      data.slice(-5).reverse().forEach(ev => {
        const li = document.createElement('li');
        li.className = 'flex justify-between border-b border-gray-700 text-sm py-1';
        const time = document.createElement('span');
        time.className = 'text-gray-400 w-24 pr-2';
        time.textContent = ev.timestamp;
        const msg = document.createElement('span');
        msg.className = 'flex-1';
        msg.textContent = ev.message;
        li.appendChild(time);
        li.appendChild(msg);
        list.appendChild(li);
      });
    })
    .catch(console.error);
}

fetchAutoTradeStatus();
fetchPositions();
fetchEvents();
setInterval(fetchAutoTradeStatus, 5000);
setInterval(fetchPositions, 5000);
setInterval(fetchEvents, 5000);
</script>
{% endblock %}
