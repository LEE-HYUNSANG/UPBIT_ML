{% extends 'base.html' %}
{% block title %}대시보드 - AUTO UPBIT{% endblock %}
{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-5 mb-10">
    <div class="bg-gray-800 rounded-2xl shadow p-6 flex flex-col justify-center items-start h-36 min-w-[180px]">
        <div class="text-xs text-gray-400 mb-1">KRW 잔고</div>
        <div id="account-balance" class="text-3xl font-extrabold tracking-tight mt-1">0</div>
        <button id="reload-account" class="text-xs text-green-400 mt-2">리로드</button>
    </div>
    <div class="bg-gray-800 rounded-2xl shadow p-6 flex flex-col justify-center items-start h-36 min-w-[180px]">
        <div class="text-xs text-gray-400 mb-1">오늘 손익(PnL)</div>
        <div class="flex items-baseline mt-1">
            <span id="daily-pnl" class="text-3xl font-extrabold tracking-tight mr-2">0</span>
            <span id="daily-pnl-percent" class="text-xl font-bold text-green-400 align-middle">0%</span>
        </div>
    </div>
    <div class="bg-gray-800 rounded-2xl p-7 shadow lg:col-span-1 lg:row-span-2">
        <div class="flex justify-between items-center mb-2">
            <h2 class="card-title flex items-center gap-1"><span>📊</span>매도 모니터링</h2>
        </div>
        <div class="overflow-x-auto max-h-40">
            <table class="w-full text-sm text-center">
                <thead>
                    <tr class="text-gray-400">
                        <th>코인</th><th>수량</th><th>현재가</th><th>평가금액</th><th>수익률</th>
                    </tr>
                </thead>
                <tbody id="sell-body"></tbody>
            </table>
        </div>
    </div>
</div>
<div class="bg-gray-800 rounded-2xl p-7 shadow mb-6">
    <h2 class="card-title mb-2 flex items-center gap-1"><span>📈</span>매수 모니터링</h2>
    <div class="overflow-x-auto">
            <table class="w-full text-sm text-center">
                <thead>
                    <tr class="text-gray-400">
                        <th>코인</th><th>ML</th><th>추세</th><th>RSI</th><th>Ver.</th><th>예상 승률</th><th>예상 수익률</th>
                    </tr>
                </thead>
                <tbody id="buy-body" class="divide-y divide-gray-700/50"></tbody>
            </table>
        </div>
</div>
<div class="bg-gray-800 rounded-2xl p-7 shadow mt-6">
    <div class="flex justify-between items-center mb-2">
        <h2 class="card-title">알림 기록</h2>
        <button onclick="clearAlerts()" class="text-sm text-green-400">전체 삭제</button>
    </div>
    <div class="max-h-40 overflow-y-auto pr-1">
        <table class="w-full text-sm text-left">
            <thead>
                <tr class="text-gray-400">
                    <th class="w-32">시간</th>
                    <th class="w-24">구분</th>
                    <th>내용</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="alert-body"></tbody>
        </table>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
function updateAccount(){
    fetch('/api/account').then(r=>r.json()).then(d=>{
        const bal=document.getElementById('account-balance');
        if(bal) bal.textContent=Math.floor(d.krw_balance||0).toLocaleString();
    });
}
updateAccount();
setInterval(updateAccount,5000);
document.getElementById('reload-account').onclick=updateAccount;

function fetchPositions(){
    fetch('/api/open_positions').then(r=>r.json()).then(list=>{
        const body=document.getElementById('sell-body');
        body.innerHTML='';
        list.forEach(p=>{
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${p.symbol.replace('KRW-','')}</td><td>${p.qty||0}</td>`+
                `<td>${Math.floor(p.current_price||0)}</td><td>${Math.floor(p.eval_amount||0)}</td>`+
                `<td>${Number(p.pnl_percent||0).toFixed(2)}%</td>`;
            body.appendChild(tr);
        });
    });
}
fetchPositions();
setInterval(fetchPositions,5000);

function fetchSignals(){
    fetch('/api/buy_monitoring').then(r=>r.json()).then(list=>{
        const body=document.getElementById('buy-body');
        body.innerHTML='';
        list.forEach(it=>{
            const win=it.win_rate!==undefined?`${(it.win_rate*100).toFixed(1)}%`:'-';
            const roi=it.avg_roi!==undefined?`${(it.avg_roi*100).toFixed(1)}%`:'-';
            const ver=it.version||'-';
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${it.symbol.replace('KRW-','')}</td>`+
                `<td>${it.ml_signal?'O':'X'}</td>`+
                `<td>${it.trend_sel?'O':'X'}</td>`+
                `<td>${it.rsi_sel?'O':'X'}</td>`+
                `<td>${ver}</td><td>${win}</td><td>${roi}</td>`;
            body.appendChild(tr);
        });
    });
}
fetchSignals();
setInterval(fetchSignals,5000);

function fetchAlerts(){
    fetch('/api/events?limit=3').then(r=>r.json()).then(list=>{
        const body=document.getElementById('alert-body');
        body.innerHTML='';
        list.reverse().forEach(ev=>{
            const tr=document.createElement('tr');
            const time=new Date(ev.timestamp||ev.time||Date.now());
            const ts=time instanceof Date&&!isNaN(time)?time.toISOString().replace('T',' ').substring(0,19):'';
            tr.innerHTML=`<td>${ts}</td><td>${ev.type||'시스템'}</td><td>${ev.message}</td>`+
                `<td class='text-right'><button onclick='this.parentElement.parentElement.remove()'>삭제</button></td>`;
            body.prepend(tr);
        });
    });
}
fetchAlerts();
setInterval(fetchAlerts,5000);

function clearAlerts(){
    document.getElementById('alert-body').innerHTML='';
}

</script>
{% endblock %}
