{% extends 'base.html' %}
{% block title %}대시보드 - AUTO UPBIT{% endblock %}
{% block content %}
<div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-10">
    <div class="bg-gray-800 rounded-2xl shadow p-6 flex flex-col justify-center items-start h-36 min-w-[180px]">
        <div class="text-xs text-gray-400 mb-1">KRW 잔고</div>
        <div id="account-balance" class="text-3xl font-extrabold tracking-tight mt-1">0</div>
        <button id="reload-account" class="text-xs text-green-400 mt-2">리로드</button>
    </div>
    <div class="bg-gray-800 rounded-2xl shadow p-6 flex flex-col justify-center items-start h-36 min-w-[180px]">
        <div class="text-xs text-gray-400 mb-1">오늘 손익(PnL)</div>
        <div class="flex items-baseline mt-1">
            <span id="daily-pnl" class="text-3xl font-extrabold tracking-tight mr-2">0</span>
            <span id="daily-pnl-percent" class="text-xl font-bold text-green-400 align-middle">0%</span>
        </div>
    </div>
    <div class="bg-gray-800 rounded-2xl shadow p-6 flex flex-col h-36 min-w-[240px]">
        <div class="flex items-center justify-between mb-2">
            <span class="card-title text-white">모니터링 코인</span>
            <button onclick="openExclude()" class="text-gray-400 hover:text-green-400 p-1 rounded-full transition" title="감시 제외">
                ⚙
            </button>
        </div>
        <div class="flex flex-wrap gap-2 mt-2 mb-1" id="monitor-coins"></div>
    </div>
    <div class="bg-gray-800 rounded-2xl shadow p-6 flex flex-col justify-between h-36 min-w-[200px]">
        <span class="card-title text-white mb-2">자동매매</span>
        <span id="run-status" class="w-full px-3 py-1 rounded-full text-sm font-bold bg-gray-700 text-gray-300 text-center mb-1">정지됨</span>
        <div class="text-xs text-gray-400 text-right w-full mt-1">상태는 상단 토글과 연동됩니다</div>
    </div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-gray-800 rounded-2xl p-7 shadow">
        <div class="flex justify-between items-center mb-2">
            <h2 class="font-bold">매도 모니터링</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-center">
                <thead>
                    <tr class="text-gray-400">
                        <th>코인</th><th>수량</th><th>현재가</th><th>평가금액</th><th>수익률</th>
                    </tr>
                </thead>
                <tbody id="sell-body"></tbody>
            </table>
        </div>
    </div>
    <div class="bg-gray-800 rounded-2xl p-7 shadow">
        <h2 class="font-bold mb-2">매수 모니터링</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-center">
                <thead>
                    <tr class="text-gray-400">
                        <th>코인</th><th>ML</th><th>추세</th><th>RSI</th><th>Ver.</th><th>예상 승률</th><th>예상 수익률</th>
                    </tr>
                </thead>
                <tbody id="buy-body"></tbody>
            </table>
        </div>
    </div>
</div>
<div class="bg-gray-800 rounded-2xl p-7 shadow mt-6">
    <div class="flex justify-between items-center mb-2">
        <h2 class="font-bold">알림 기록</h2>
        <button onclick="clearAlerts()" class="text-sm text-green-400">전체 삭제</button>
    </div>
    <div class="max-h-40 overflow-y-auto pr-1">
        <table class="w-full text-sm text-left">
            <thead>
                <tr class="text-gray-400">
                    <th class="w-32">시간</th>
                    <th class="w-24">구분</th>
                    <th>내용</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="alert-body"></tbody>
        </table>
    </div>
</div>
<div id="exclude-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-xl w-80">
        <div class="flex justify-between mb-2">
            <h3 class="font-bold">감시 제외</h3>
            <button onclick="closeExclude()" class="text-xl">&times;</button>
        </div>
        <table class="w-full text-sm text-center">
            <thead>
                <tr class="text-gray-400"><th>코인</th><th>삭제</th></tr>
            </thead>
            <tbody id="exclude-body"></tbody>
        </table>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
function updateAccount(){
    fetch('/api/account').then(r=>r.json()).then(d=>{
        const bal=document.getElementById('account-balance');
        if(bal) bal.textContent=Math.floor(d.krw_balance||0).toLocaleString();
    });
}
updateAccount();
setInterval(updateAccount,5000);
document.getElementById('reload-account').onclick=updateAccount;

function fetchPositions(){
    fetch('/api/open_positions').then(r=>r.json()).then(list=>{
        const body=document.getElementById('sell-body');
        body.innerHTML='';
        list.forEach(p=>{
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${p.symbol.replace('KRW-','')}</td><td>${p.qty||0}</td>`+
                `<td>${Math.floor(p.current_price||0)}</td><td>${Math.floor(p.eval_amount||0)}</td>`+
                `<td>${Number(p.pnl_percent||0).toFixed(2)}%</td>`;
            body.appendChild(tr);
        });
    });
}
fetchPositions();
setInterval(fetchPositions,5000);

function fetchSignals(){
    fetch('/api/signals').then(r=>r.json()).then(data=>{
        const body=document.getElementById('buy-body');
        body.innerHTML='';
        Object.keys(data).forEach(k=>{
            const tr=document.createElement('tr');
            const v=data[k];
            tr.innerHTML=`<td>${k.replace('KRW-','')}</td><td>${v.buy_signal?'O':'X'}</td>`+
                `<td>-</td><td>-</td><td>v1</td><td>60%</td><td>3%</td>`;
            body.appendChild(tr);
        });
    });
}
fetchSignals();
setInterval(fetchSignals,5000);

function fetchAlerts(){
    fetch('/api/events?limit=3').then(r=>r.json()).then(list=>{
        const body=document.getElementById('alert-body');
        body.innerHTML='';
        list.reverse().forEach(ev=>{
            const tr=document.createElement('tr');
            const time=new Date(ev.timestamp||ev.time||Date.now());
            const ts=time instanceof Date&&!isNaN(time)?time.toISOString().replace('T',' ').substring(0,19):'';
            tr.innerHTML=`<td>${ts}</td><td>${ev.type||'시스템'}</td><td>${ev.message}</td>`+
                `<td class='text-right'><button onclick='this.parentElement.parentElement.remove()'>삭제</button></td>`;
            body.prepend(tr);
        });
    });
}
fetchAlerts();
setInterval(fetchAlerts,5000);

function clearAlerts(){
    document.getElementById('alert-body').innerHTML='';
}

document.addEventListener('DOMContentLoaded', () => {
    const coins = {{ universe|tojson }} || [];
    const cont = document.getElementById('monitor-coins');
    if (cont) {
        coins.slice(0, 6).forEach(c => {
            const el = document.createElement('span');
            el.className = 'inline-block w-8 h-8 rounded-full bg-green-400 text-xs flex items-center justify-center font-bold';
            el.textContent = c.replace('KRW-', '');
            cont.appendChild(el);
        });
    }
});

function openExclude(){
    document.getElementById('exclude-modal').classList.remove('hidden');
}
function closeExclude(){
    document.getElementById('exclude-modal').classList.add('hidden');
}
</script>
{% endblock %}
